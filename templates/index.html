{% extends "base.html" %}

{% block title %}Главная - BAL_BUS{% endblock %}

{% block content %}
<!-- Начальный экран - выбор роли -->
<div id="roleSelection" class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i class="bi bi-bus-front"></i> BAL_BUS
            </h1>
            <p class="lead text-muted">Система управления автобусными рейсами</p>
        </div>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-lg h-100 role-card border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-center p-5 text-white">
                        <i class="bi bi-person-circle" style="font-size: 5rem; color: white; display: block; margin-bottom: 1rem;"></i>
                        <h3 class="card-title mb-3 fw-bold">Я пассажир</h3>
                        <p class="card-text mb-4 opacity-90">
                            Просмотр расписания рейсов<br>без регистрации
                        </p>
                        <button class="btn btn-light btn-lg w-100 fw-bold" id="rolePassenger">
                            <i class="bi bi-arrow-right-circle me-2"></i>Продолжить как пассажир
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-lg h-100 role-card border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-body text-center p-5 text-white">
                        <i class="bi bi-gear-fill" style="font-size: 5rem; color: white; display: block; margin-bottom: 1rem;"></i>
                        <h3 class="card-title mb-3 fw-bold">Я диспетчер</h3>
                        <p class="card-text mb-4 opacity-90">
                            Управление рейсами<br>Требуется вход в систему
                        </p>
                        <button class="btn btn-light btn-lg w-100 fw-bold" id="roleDispatcher">
                            <i class="bi bi-shield-lock me-2"></i>Войти как диспетчер
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Контент для пассажира -->
<div id="passengerContent" style="display:none;">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white d-flex flex-wrap gap-2 align-items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
            <span class="fw-bold"><i class="bi bi-calendar-week me-2"></i>Расписание рейсов</span>
            <div class="ms-auto d-flex gap-2 align-items-center">
                <input type="date" class="form-control form-control-sm" id="datePicker" style="max-width: 180px; border-radius: 8px;">
                <button class="btn btn-light btn-sm" id="btnToday">
                    <i class="bi bi-calendar-day me-1"></i>Сегодня
                </button>
                <button class="btn btn-light btn-sm" id="btnTomorrow">
                    <i class="bi bi-calendar-check me-1"></i>Завтра
                </button>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tripsTable">
                    <thead>
                        <tr>
                            <th><i class="bi bi-geo-alt me-1"></i>Откуда</th>
                            <th><i class="bi bi-geo-alt-fill me-1"></i>Куда</th>
                            <th><i class="bi bi-clock me-1"></i>Отправление</th>
                            <th><i class="bi bi-clock-history me-1"></i>Прибытие</th>
                            <th><i class="bi bi-currency-exchange me-1"></i>Цена</th>
                        </tr>
                    </thead>
                    <tbody id="tripsBody">
                        <tr><td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Контент для диспетчера (форма входа/регистрации) -->
<div id="dispatcherAuth" style="display:none;">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-0">
                <div class="card-header text-white text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h4 class="mb-0 fw-bold"><i class="bi bi-shield-lock me-2"></i>Вход для диспетчера</h4>
                </div>
                <div class="card-body p-4">
                    <div id="authAlert"></div>
                    <ul class="nav nav-tabs mb-4" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button">
                                <i class="bi bi-box-arrow-in-right me-2"></i>Вход
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="register-tab" data-bs-toggle="tab" data-bs-target="#register" type="button">
                                <i class="bi bi-person-plus me-2"></i>Регистрация
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="authTabContent">
                        <div class="tab-pane fade show active" id="login" role="tabpanel">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-person me-1"></i>Имя пользователя</label>
                                    <input type="text" class="form-control" id="loginUsername" required>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold"><i class="bi bi-lock me-1"></i>Пароль</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 fw-bold">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Войти
                                </button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="register" role="tabpanel">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-envelope me-1"></i>Email</label>
                                    <input type="email" class="form-control" id="regEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-person me-1"></i>Имя пользователя</label>
                                    <input type="text" class="form-control" id="regUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-lock me-1"></i>Пароль</label>
                                    <input type="password" class="form-control" id="regPassword" required minlength="6">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold"><i class="bi bi-lock-fill me-1"></i>Подтверждение пароля</label>
                                    <input type="password" class="form-control" id="regPasswordConfirm" required>
                                </div>
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="isDispatcher" checked>
                                    <label class="form-check-label fw-bold" for="isDispatcher">
                                        <i class="bi bi-shield-check me-1"></i>Я диспетчер
                                    </label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 fw-bold">
                                    <i class="bi bi-person-plus me-2"></i>Зарегистрироваться
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Контент для диспетчера (после входа) -->
<div id="dispatcherContent" style="display:none;">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <span class="fw-bold"><i class="bi bi-person-badge me-2"></i>Режим диспетчера: <strong id="dispatcherName"></strong></span>
                <button class="btn btn-light btn-sm" id="logoutBtn">
                    <i class="bi bi-box-arrow-right me-1"></i>Выйти
                </button>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header text-white d-flex flex-wrap gap-2 align-items-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span class="fw-bold"><i class="bi bi-calendar-week me-2"></i>Расписание рейсов</span>
                    <div class="ms-auto d-flex gap-2 align-items-center">
                        <input type="date" class="form-control form-control-sm" id="dispatcherDatePicker" style="max-width: 180px; border-radius: 8px;">
                        <button class="btn btn-light btn-sm" id="dispatcherBtnToday">
                            <i class="bi bi-calendar-day me-1"></i>Сегодня
                        </button>
                        <button class="btn btn-light btn-sm" id="dispatcherBtnTomorrow">
                            <i class="bi bi-calendar-check me-1"></i>Завтра
                        </button>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="dispatcherTripsTable">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-geo-alt me-1"></i>Откуда</th>
                                    <th><i class="bi bi-geo-alt-fill me-1"></i>Куда</th>
                                    <th><i class="bi bi-clock me-1"></i>Отправление</th>
                                    <th><i class="bi bi-clock-history me-1"></i>Прибытие</th>
                                    <th><i class="bi bi-currency-exchange me-1"></i>Цена</th>
                                    <th><i class="bi bi-tools me-1"></i>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="dispatcherTripsBody">
                                <tr><td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Загрузка...</span>
                                    </div>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-lg border-0">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-tools me-2"></i>Панель управления</h5>
                </div>
                <div class="card-body p-4">
                    <form id="tripForm">
                        <input type="hidden" id="tripId">
                        <div class="mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-geo-alt me-1"></i>Откуда</label>
                            <input type="text" class="form-control" id="origin" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-geo-alt-fill me-1"></i>Куда</label>
                            <input type="text" class="form-control" id="destination" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-clock me-1"></i>Время отправления</label>
                            <input type="datetime-local" class="form-control" id="departure_time" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold"><i class="bi bi-clock-history me-1"></i>Время прибытия</label>
                            <input type="datetime-local" class="form-control" id="arrival_time" required>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="bi bi-currency-exchange me-1"></i>Цена (₽)</label>
                            <input type="number" class="form-control" id="price" step="0.01" min="0" required>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary fw-bold" id="saveBtn">
                                <i class="bi bi-save me-2"></i>Сохранить
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Сбросить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const roleSelection = document.getElementById('roleSelection');
    const passengerContent = document.getElementById('passengerContent');
    const dispatcherAuth = document.getElementById('dispatcherAuth');
    const dispatcherContent = document.getElementById('dispatcherContent');
    const rolePassengerBtn = document.getElementById('rolePassenger');
    const roleDispatcherBtn = document.getElementById('roleDispatcher');
    const tripsBody = document.getElementById('tripsBody');
    const dispatcherTripsBody = document.getElementById('dispatcherTripsBody');
    const datePicker = document.getElementById('datePicker');
    const dispatcherDatePicker = document.getElementById('dispatcherDatePicker');
    const btnToday = document.getElementById('btnToday');
    const btnTomorrow = document.getElementById('btnTomorrow');
    const dispatcherBtnToday = document.getElementById('dispatcherBtnToday');
    const dispatcherBtnTomorrow = document.getElementById('dispatcherBtnTomorrow');
    const tripForm = document.getElementById('tripForm');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const authAlert = document.getElementById('authAlert');
    const dispatcherName = document.getElementById('dispatcherName');
    const logoutBtn = document.getElementById('logoutBtn');

    function getToken() {
        return localStorage.getItem('token');
    }

    function setToken(token) {
        localStorage.setItem('token', token);
    }

    function removeToken() {
        localStorage.removeItem('token');
    }

    async function fetchMe() {
        const token = getToken();
        if (!token) return null;
        try {
            const res = await fetch('/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) return null;
            return res.json();
        } catch {
            return null;
        }
    }

    function formatDateTime(dt) {
        return new Date(dt).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' });
    }

    function isoDate(d) {
        const tzoff = d.getTimezoneOffset() * 60000;
        return new Date(d - tzoff).toISOString().slice(0, 10);
    }

    async function loadTrips(dateVal, isDispatcher = false) {
        const query = dateVal ? `?departure_date=${dateVal}&_t=${Date.now()}` : `?_t=${Date.now()}`;
        const res = await fetch('/api/trips/' + query);
        const data = await res.json();
        const targetBody = isDispatcher ? dispatcherTripsBody : tripsBody;
        targetBody.innerHTML = '';
        
        if (!data.length) {
            targetBody.innerHTML = `<tr><td colspan="${isDispatcher ? 6 : 5}" class="text-center py-4 text-muted">
                <i class="bi bi-inbox display-6 d-block mb-2"></i>Нет рейсов на выбранную дату
            </td></tr>`;
            return;
        }
        
        data.forEach(trip => {
            const tr = document.createElement('tr');
            if (isDispatcher) {
                tr.innerHTML = `
                    <td><strong>${trip.origin}</strong></td>
                    <td><strong>${trip.destination}</strong></td>
                    <td>${formatDateTime(trip.departure_time)}</td>
                    <td>${formatDateTime(trip.arrival_time)}</td>
                    <td><span class="badge bg-success fs-6">${trip.price} ₽</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-2" data-edit="${trip.id}" title="Редактировать">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" data-del="${trip.id}" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tr.querySelector('button[data-edit]').addEventListener('click', () => {
                    document.getElementById('tripId').value = trip.id;
                    document.getElementById('origin').value = trip.origin;
                    document.getElementById('destination').value = trip.destination;
                    document.getElementById('departure_time').value = trip.departure_time.slice(0, 16);
                    document.getElementById('arrival_time').value = trip.arrival_time.slice(0, 16);
                    document.getElementById('price').value = trip.price;
                });
                tr.querySelector('button[data-del]').addEventListener('click', async () => {
                    if (!confirm('Удалить рейс?')) return;
                    const token = getToken();
                    await fetch(`/api/trips/${trip.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadDispatcherTrips();
                });
            } else {
                tr.innerHTML = `
                    <td><strong>${trip.origin}</strong></td>
                    <td><strong>${trip.destination}</strong></td>
                    <td>${formatDateTime(trip.departure_time)}</td>
                    <td>${formatDateTime(trip.arrival_time)}</td>
                    <td><span class="badge bg-success fs-6">${trip.price} ₽</span></td>
                `;
            }
            targetBody.appendChild(tr);
        });
    }

    async function loadDispatcherTrips() {
        const dateVal = dispatcherDatePicker.value || isoDate(new Date());
        await loadTrips(dateVal, true);
    }

    // Выбор роли - Пассажир
    rolePassengerBtn.addEventListener('click', () => {
        roleSelection.style.display = 'none';
        passengerContent.style.display = '';
        const today = new Date();
        datePicker.value = isoDate(today);
        loadTrips(isoDate(today));
    });

    // Выбор роли - Диспетчер
    roleDispatcherBtn.addEventListener('click', async () => {
        const me = await fetchMe();
        if (me?.is_dispatcher) {
            roleSelection.style.display = 'none';
            dispatcherContent.style.display = '';
            dispatcherName.textContent = me.username;
            const today = new Date();
            dispatcherDatePicker.value = isoDate(today);
            loadDispatcherTrips();
        } else {
            roleSelection.style.display = 'none';
            dispatcherAuth.style.display = '';
        }
    });

    // Вход
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('username', document.getElementById('loginUsername').value);
        formData.append('password', document.getElementById('loginPassword').value);
        
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (res.ok) {
                setToken(data.access_token);
                const me = await fetchMe();
                if (me?.is_dispatcher) {
                    dispatcherAuth.style.display = 'none';
                    dispatcherContent.style.display = '';
                    dispatcherName.textContent = me.username;
                    const today = new Date();
                    dispatcherDatePicker.value = isoDate(today);
                    loadDispatcherTrips();
                } else {
                    showAlert('Вы не являетесь диспетчером', 'danger');
                }
            } else {
                showAlert(data.detail || 'Ошибка входа', 'danger');
            }
        } catch (error) {
            showAlert('Ошибка соединения', 'danger');
        }
    });

    // Регистрация
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        if (password !== passwordConfirm) {
            showAlert('Пароли не совпадают', 'danger');
            return;
        }
        
        const data = {
            email: document.getElementById('regEmail').value,
            username: document.getElementById('regUsername').value,
            password: password,
            is_dispatcher: document.getElementById('isDispatcher').checked
        };
        
        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (res.ok) {
                showAlert('Регистрация успешна! Теперь войдите', 'success');
                document.getElementById('login-tab').click();
            } else {
                showAlert(result.detail || 'Ошибка регистрации', 'danger');
            }
        } catch (error) {
            showAlert('Ошибка соединения', 'danger');
        }
    });

    // Выход
    logoutBtn.addEventListener('click', () => {
        removeToken();
        dispatcherContent.style.display = 'none';
        roleSelection.style.display = '';
    });

    // Форма рейса
    tripForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = getToken();
        const payload = {
            origin: document.getElementById('origin').value,
            destination: document.getElementById('destination').value,
            departure_time: document.getElementById('departure_time').value,
            arrival_time: document.getElementById('arrival_time').value,
            price: parseFloat(document.getElementById('price').value || '0')
        };
        const id = document.getElementById('tripId').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/trips/${id}` : '/api/trips/';
        
        try {
            const res = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                tripForm.reset();
                document.getElementById('tripId').value = '';
                loadDispatcherTrips();
            } else {
                alert('Ошибка сохранения');
            }
        } catch (error) {
            alert('Ошибка соединения');
        }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        tripForm.reset();
        document.getElementById('tripId').value = '';
    });

    // Фильтры дат для пассажира
    btnToday.addEventListener('click', () => {
        datePicker.value = isoDate(new Date());
        loadTrips(datePicker.value);
    });

    btnTomorrow.addEventListener('click', () => {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        datePicker.value = isoDate(d);
        loadTrips(datePicker.value);
    });

    datePicker.addEventListener('change', () => {
        loadTrips(datePicker.value);
    });

    // Фильтры дат для диспетчера
    dispatcherBtnToday.addEventListener('click', () => {
        dispatcherDatePicker.value = isoDate(new Date());
        loadDispatcherTrips();
    });

    dispatcherBtnTomorrow.addEventListener('click', () => {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        dispatcherDatePicker.value = isoDate(d);
        loadDispatcherTrips();
    });

    dispatcherDatePicker.addEventListener('change', () => {
        loadDispatcherTrips();
    });

    function showAlert(message, type) {
        authAlert.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }

    // Проверка авторизации при загрузке
    (async () => {
        const me = await fetchMe();
        if (me?.is_dispatcher) {
            roleSelection.style.display = 'none';
            dispatcherContent.style.display = '';
            dispatcherName.textContent = me.username;
            const today = new Date();
            dispatcherDatePicker.value = isoDate(today);
            loadDispatcherTrips();
        }
    })();
</script>
{% endblock %}
